<!DOCTYPE html>
<html>
<head>
  <title>Markdown Viewer</title>
  <style>
    :root {
      --theme-text: #161616;
      --theme-body-background-medium: #f2f2f2;
      --theme-text-glow-high-contrast: #171717;
      --theme-hyperlink: #0065b3;
      --theme-text-subtle: #505050;
    }

    html {
      text-size-adjust: 100%;
      font-size: 16px;
      overflow-x: hidden;
      overflow-y: scroll;

      -webkit-font-smoothing: antialiased;
      text-rendering: optimizelegibility;
      font-family: Segoe UI,SegoeUI,Helvetica Neue,Helvetica,Arial,sans-serif;
    }
    body {
      color: var(--theme-text);
      line-height: 160%;

      display: flex;
      flex-direction: column;
      min-height: 100vh;
      margin: 0;
    }

    header {
      background-color: #333;
      color: #fff;
      padding: 10px;
      text-align: center;
	  
      height: 71px;
    }

    main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    a {
      color: var(--theme-hyperlink);
      text-decoration: none;
    }

    @font-face {
      font-family: docons;
      src: url(/third-party/fonts/docons.3d25fd3d.woff2)format("woff2");
      font-weight: 400;
      font-style: normal
    }

    #leftPane {
      flex: 0 0 30%;
      padding: 20px;
      overflow-y: auto;
    }

    #rightPane {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    #fileList {
      font-size: .875rem;
    }

    #fileList a {
      color: var(--theme-text)!important;
      display: block;
      margin-bottom: 5px;
      padding-left: 1rem;
    }

    #fileList a.is-selected {
      background-color: var(--theme-body-background-medium);
      font-weight: 600;
      color: var(--theme-text-glow-high-contrast)!important;
    }

    #fileContent {
      line-height: 1.6;
    }

    footer {
      background-color: #333;
      color: #fff;
      padding: 5px;
      text-align: center;
    }
  	
  	#rightPane h1 {
  	  color: #ff6f3d;
  	}
  	
  	#rightPane blockquote {
  	  background: #f9f9f9;
      border-left: 10px solid #ccc;
      margin: 1.5em 10px;
      padding: 2px 10px 2px 10px;
      quotes: "\201C""\201D""\2018""\2019";
  	}

    @media screen and (min-width: 1088px) {
      #leftPane {
        width: 25%;
        flex: none;
        overflow-y: auto;
      }
    }
	
	  /* Media query for mobile devices */
    @media screen and (max-width: 767px) {
      body {
        display: block;
      }

      #leftPane {
        display: none!important;
      }

      #rightPane {
        width: 100%;
        padding: 10px;
      }
    }

    /* Additional styles for the hierarchical file list */
    #fileList ul {
      list-style: none;
      padding-left: 0;
    }

    #fileList ul ul {
      padding-left: 1rem; /* Add padding for nested lists */
    }

    #fileList li {
      margin: 5px 0;
      display: block;
    }

    .folder {
      position: relative;
      display: block;
      cursor: pointer;
      padding-left: 1rem;
    }

    .docon {
      font-family: docons;
      font-size: inherit;
      speak: none;
      font-variant: normal;
      text-transform: none;
      direction: ltr;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      font-style: normal;
      font-weight: 400;
      line-height: 16px;
      display: inline-block;
    }

    .tree-expander-indicator {
      color: var(--theme-text-subtle);

      font-size: .55rem;
      font-weight: 600;
      transition: transform .15s ease-in-out;
      display: inline-block;
      position: absolute;
      top: 5px;
      left: 3px;
      transform: rotate(0);
    }

    .tree-expander-indicator::before {
      content: "\FF34";
    }

    .collapsed .tree-expander-indicator::before {
      transform: rotate(0deg);
    }

    .builder-code {
      width: 75%;
    }

    textarea {
        background: #f4f4f4;
        border: 1px solid #bfbfbf;
        height: 300px;
        padding: 5px;
        resize: none;
    }

    button {
        border: 0 none;
        font-family: inherit;
        font-size: 100%;
        font-style: normal;
        font-weight: normal;
        line-height: normal;
        margin: 0;
        padding: 0;
    }

    .builder-run {
        background: no-repeat center 0 transparent;
        color: #333;
        cursor: pointer;
        display: inline-block;
        float: right;
        font-weight: bold;
        padding-top: 100px;
        text-align: center;
        width: 100px;
    }

    #generateButton {
        background-image: url(content/download.png);
        margin: 80px 50px 0 0;
    }

  </style>
  <link rel="stylesheet" href="/third-party/prism/prism.css">
</head>
<body>
  <header>
    <h1>Markdown Viewer</h1>
  </header>
  <main>
    <div id="leftPane">
      <h2>GET STARTED</h2>
      <div id="fileList"></div>
    </div>
    <div id="rightPane">
      <div id="fileContent"></div>
    </div>
  </main>
  <footer>
    <p>&copy; 2023 Your Company. All rights reserved.</p>
  </footer>

  <script>
    var g_disableHistory = false;

    const fileListElement = document.getElementById('fileList');
    const ul = document.createElement('ul');
    fileListElement.appendChild(ul);

    const toDash = (str) => {
      return str.replace(/\s+/g, '-');
    };
    const toDashLower = (str)  => {
      return toDash(str).toLowerCase();
    };

    const uncollapseParentFolders = (listItem) => {
      while (listItem && listItem.classList.contains('collapsed')) {
        listItem.classList.remove('collapsed');
        const nestedUl = listItem.querySelector('ul');
        if (nestedUl) {
          nestedUl.style.display = 'block';
        }
        listItem = listItem.parentElement.closest('li[data-folder]');
      }
    };

    const getCurrentFilePath = () => {
      const pathname = window.location.pathname;
      if (pathname.startsWith('/file/') && pathname.endsWith('.md')) {
        return pathname.slice('/file/'.length);
      }
      return null;
    };

    const updateFile = (element) => {
      // Remove the "is-selected" class
      const previouslySelectedLink = fileListElement.querySelector('a.is-selected');
      if (previouslySelectedLink) {
        previouslySelectedLink.classList.remove('is-selected');
      }

      // Add the "is-selected" class to the clicked file link
      element.classList.add('is-selected');

      const filepath = element.getAttribute('href');
      showFileContent(filepath);
    };
    const onClickFile = (event) => {
      event.preventDefault(); // Prevent the default link behavior
      updateFile(event.target);
    };

    fetch('/files')
      .then((response) => response.json())
      .then((data) => {
        const fileList = data.files;
        const currentFilePath = getCurrentFilePath();

        fileList.forEach((file) => {
          const parts = file.split('/');
          let parentUl = ul;

          parts.forEach((part, index) => {
            if (!part.endsWith('.md')) {
              let listItem = parentUl.querySelector(`[data-folder="${part}"]`);
              if (!listItem) {
                listItem = document.createElement('li');
                listItem.dataset.folder = part;
                listItem.className = "collapsed"; // Add collapsed class
                const folderText = part;
                listItem.innerHTML = `<span class="folder"><span class="tree-expander-indicator docon"></span>${folderText}</span>`;

                // Add the event listener to the folder element
                listItem.querySelector('.folder').addEventListener('click', () => {
                  listItem.classList.toggle('collapsed');
                  const nestedUl = listItem.querySelector('ul');
                  if (nestedUl) {
                    nestedUl.style.display = listItem.classList.contains('collapsed') ? 'none' : 'block';
                  }
                });

                parentUl.appendChild(listItem);
              }
              if (index < parts.length - 1) {
                let nestedUl = listItem.querySelector('ul');
                if (!nestedUl) {
                  nestedUl = document.createElement('ul');
                  nestedUl.style.display = 'none'; // Set initial display to 'none'
                  listItem.appendChild(nestedUl);
                }
                parentUl = nestedUl;
              }
            } else {
              const li = document.createElement('li');
              parentUl.appendChild(li);

              const link = document.createElement('a');
              link.href = `${file}`;
              link.innerText = parts[index];
              link.onclick = onClickFile;
              li.appendChild(link);

              if (toDashLower(file) === currentFilePath) {
                uncollapseParentFolders(parentUl.parentElement);
                updateFile(link);
              }
            }
          });
        });
      });

    function updateFileContent(data) {
      const fileContentElement = document.getElementById('fileContent');
      fileContentElement.innerHTML = data;
      Prism.highlightAll();
    }
    function showFileContent(filePath) {
      const disableHistory = g_disableHistory;
      const file = toDash(filePath);
      fetch(`/_file/${file}`)
        .then((response) => response.text())
        .then((data) => {
          updateFileContent(data);

          if (!disableHistory) {
            // Update the URL without reloading the page
            const newUrl = window.location.origin + `/file/` + file.toLowerCase();
            window.history.pushState({"filePath": filePath},"", newUrl);
          }
        });
    }

    window.onpopstate = function (e) {
      if (e.state) {
        const link = fileListElement.querySelector(`a[href="${e.state.filePath}"]`);
        if (link) {
          g_disableHistory = true;
          updateFile(link);
          g_disableHistory = false;
        }
      }
    };
  </script>
  <script src="/third-party/prism/prism.js"></script>
</body>
</html>
